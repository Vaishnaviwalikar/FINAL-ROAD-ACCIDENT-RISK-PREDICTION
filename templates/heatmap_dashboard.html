<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RoadSafe AI - Interactive Risk Heatmap</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .main-container { min-height: 100vh; padding: 1rem 0; }
        .controls-section { background: rgba(255, 255, 255, 0.95); border-radius: 16px; padding: 1.5rem; margin-bottom: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .map-container { background: rgba(255, 255, 255, 0.95); border-radius: 16px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        #heatmap-map { height: 600px; width: 100%; }
        .legend { position: absolute; bottom: 20px; left: 20px; background: rgba(255, 255, 255, 0.95); padding: 1rem; border-radius: 8px; z-index: 1000; }
        .legend-color { width: 16px; height: 16px; border-radius: 2px; margin-right: 0.5rem; display: inline-block; }
        .risk-medium { background: #f59e0b; }
        .risk-high { background: #ef4444; }
        .risk-extreme { background: #7c2d12; }
        .btn-generate { background: linear-gradient(135deg, #1e40af, #3b82f6); border: none; border-radius: 8px; padding: 0.75rem 1.5rem; color: white; font-weight: 600; width: 100%; }
        .loading-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.9); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .spinner { width: 40px; height: 40px; border: 4px solid #e5e7eb; border-top: 4px solid #1e40af; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container main-container">
        <div class="text-center mb-4">
            <h1><i class="fas fa-fire"></i> Interactive Risk Heatmap</h1>
            <p class="text-muted">Visual risk analysis with real-time data</p>
        </div>

        <div class="row g-4">
            <div class="col-lg-4">
                <div class="controls-section">
                    <h3><i class="fas fa-sliders-h"></i> Controls</h3>
                    
                    <div class="mb-3">
                        <label class="form-label">Location Search</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="location-search" placeholder="Enter city name">
                            <button class="btn btn-outline-primary" id="search-btn">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-6">
                            <label class="form-label">Latitude</label>
                            <input type="number" class="form-control" id="center-lat" value="19.0760" step="0.0001">
                        </div>
                        <div class="col-6">
                            <label class="form-label">Longitude</label>
                            <input type="number" class="form-control" id="center-lon" value="72.8777" step="0.0001">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Radius (km)</label>
                        <select class="form-control" id="radius-select">
                            <option value="2">2 km</option>
                            <option value="5" selected>5 km</option>
                            <option value="10">10 km</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Resolution</label>
                        <select class="form-control" id="resolution-select">
                            <option value="10">10x10</option>
                            <option value="15" selected>15x15</option>
                            <option value="20">20x20</option>
                        </select>
                    </div>

                    <button class="btn-generate" id="generate-btn">
                        <i class="fas fa-fire"></i> Generate Heatmap
                    </button>
                </div>

                <div class="controls-section" id="statistics-panel" style="display: none;">
                    <h4><i class="fas fa-chart-bar"></i> Statistics</h4>
                    <div class="row g-2">
                        <div class="col-6">
                            <div class="text-center p-2 bg-light rounded">
                                <div class="fw-bold text-primary" id="avg-risk">-</div>
                                <small>Avg Risk</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center p-2 bg-light rounded">
                                <div class="fw-bold text-primary" id="high-risk-areas">-</div>
                                <small>High Risk Areas</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-8">
                <div class="map-container">
                    <div id="heatmap-map"></div>
                    <div class="loading-overlay" id="loading-overlay">
                        <div>
                            <div class="spinner"></div>
                            <p class="mt-2">Generating heatmap...</p>
                        </div>
                    </div>
                </div>

                <div class="legend">
                    <div class="fw-bold mb-2">Risk Levels</div>
                    <div class="mb-1">
                        <span class="legend-color risk-medium"></span>
                        <small>Medium (30-50%)</small>
                    </div>
                    <div class="mb-1">
                        <span class="legend-color risk-high"></span>
                        <small>High (50-70%)</small>
                    </div>
                    <div class="mb-1">
                        <span class="legend-color risk-extreme"></span>
                        <small>Extreme (>70%)</small>
                    </div>
                    <div class="mt-2 pt-2 border-top text-center" id="data-source-indicator">
                        <i class="fas fa-circle text-success"></i>
                        <small>Live Analysis</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let heatmapMap;
        let heatmapLayer;

        document.addEventListener('DOMContentLoaded', function() {
            initializeMap();
            setupEventListeners();
            setTimeout(generateHeatmap, 1000);
        });

        function initializeMap() {
            heatmapMap = L.map('heatmap-map').setView([19.0760, 72.8777], 11);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(heatmapMap);

            heatmapMap.on('click', function(e) {
                const lat = e.latlng.lat;
                const lng = e.latlng.lng;
                document.getElementById('center-lat').value = lat.toFixed(6);
                document.getElementById('center-lon').value = lng.toFixed(6);
            });
        }

        function setupEventListeners() {
            document.getElementById('search-btn').addEventListener('click', searchLocation);
            document.getElementById('generate-btn').addEventListener('click', generateHeatmap);
        }

        async function searchLocation() {
            const locationInput = document.getElementById('location-search').value.trim();
            if (!locationInput) {
                alert('Please enter a location');
                return;
            }

            try {
                const response = await fetch('/geocode_city', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ city: locationInput })
                });

                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('center-lat').value = data.latitude.toFixed(6);
                    document.getElementById('center-lon').value = data.longitude.toFixed(6);
                    heatmapMap.setView([data.latitude, data.longitude], 12);
                    generateHeatmap();
                } else {
                    alert('Location not found');
                }
            } catch (error) {
                alert('Search failed');
            }
        }

        async function generateHeatmap() {
            const generateBtn = document.getElementById('generate-btn');
            const loadingOverlay = document.getElementById('loading-overlay');

            generateBtn.disabled = true;
            generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
            loadingOverlay.style.display = 'flex';

            try {
                if (heatmapLayer) {
                    heatmapMap.removeLayer(heatmapLayer);
                }

                const params = {
                    center_lat: parseFloat(document.getElementById('center-lat').value),
                    center_lon: parseFloat(document.getElementById('center-lon').value),
                    radius_km: parseFloat(document.getElementById('radius-select').value),
                    grid_resolution: parseInt(document.getElementById('resolution-select').value)
                };

                const response = await fetch('/api/heatmap/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(params)
                });

                if (response.ok) {
                    const data = await response.json();
                    displayHeatmap(data.heatmap);
                    updateStatistics(data.heatmap.statistics);
                    heatmapMap.setView([params.center_lat, params.center_lon], getZoomLevel(params.radius_km));
                } else {
                    throw new Error('Failed to generate heatmap');
                }
            } catch (error) {
                alert('Failed to generate heatmap');
            } finally {
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<i class="fas fa-fire"></i> Generate Heatmap';
                loadingOverlay.style.display = 'none';
            }
        }

        function displayHeatmap(heatmapData) {
            const significantPoints = heatmapData.points.filter(function(point) {
                return point.risk_level > 0.3;
            });
            
            const gridSize = 0.01;
            const pointGroups = {};

            significantPoints.forEach(function(point) {
                const gridKey = Math.round(point.lat / gridSize) + '_' + Math.round(point.lon / gridSize);
                if (!pointGroups[gridKey]) pointGroups[gridKey] = [];
                pointGroups[gridKey].push(point);
            });

            Object.values(pointGroups).forEach(function(group) {
                const avgLat = group.reduce(function(sum, p) { return sum + p.lat; }, 0) / group.length;
                const avgLon = group.reduce(function(sum, p) { return sum + p.lon; }, 0) / group.length;
                const maxRisk = Math.max.apply(Math, group.map(function(p) { return p.risk_level; }));
                
                let color = '#f59e0b';
                let radius = 8;
                if (maxRisk > 0.7) { color = '#7c2d12'; radius = 12; }
                else if (maxRisk > 0.5) { color = '#ef4444'; radius = 10; }

                const factors = [];
                group.forEach(function(p) {
                    p.contributing_factors.forEach(function(f) {
                        if (factors.indexOf(f) === -1) factors.push(f);
                    });
                });

                L.circleMarker([avgLat, avgLon], {
                    radius: radius,
                    fillColor: color,
                    color: '#fff',
                    weight: 2,
                    opacity: 0.9,
                    fillOpacity: 0.7
                }).bindPopup(
                    '<div style="min-width: 200px;">' +
                    '<h6><i class="fas fa-map-marker-alt"></i> Risk Zone</h6>' +
                    '<strong>Risk: ' + Math.round(maxRisk * 100) + '%</strong><br>' +
                    '<strong>Factors:</strong><br>' +
                    factors.slice(0, 3).map(function(f) { return 'â¢ ' + f; }).join('<br>') + '<br><br>' +
                    '<small><i class="fas fa-database"></i> Live Analysis Data</small>' +
                    '</div>'
                ).addTo(heatmapMap);
            });
        }

        function updateStatistics(stats) {
            document.getElementById('avg-risk').textContent = Math.round(stats.avg_risk * 100) + '%';
            document.getElementById('high-risk-areas').textContent = stats.high_risk_areas;
            document.getElementById('statistics-panel').style.display = 'block';
        }

        function getZoomLevel(radiusKm) {
            if (radiusKm <= 2) return 13;
            if (radiusKm <= 5) return 12;
            if (radiusKm <= 10) return 11;
            return 10;
        }
    </script>
</body>
</html>