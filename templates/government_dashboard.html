<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Government Traffic Safety Portal - Real Data Analytics</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- CSS Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        :root {
            --gov-primary: #1e40af;
            --gov-secondary: #059669;
            --gov-accent: #dc2626;
            --gov-warning: #d97706;
            --gov-bg: #f8fafc;
            --gov-card: #ffffff;
            --gov-border: #e2e8f0;
            --gov-text: #1f2937;
            --gov-text-light: #64748b;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--gov-bg);
            color: var(--gov-text);
            line-height: 1.6;
        }

        /* Header */
        .gov-header {
            background: linear-gradient(135deg, var(--gov-primary) 0%, #3b82f6 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-lg);
        }

        .gov-title {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .gov-subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 1.5rem;
        }

        /* Status Bar */
        .status-bar {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            display: flex;
            justify-content: center;
            gap: 2rem;
            flex-wrap: wrap;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-live { background: #10b981; }
        .status-partial { background: #f59e0b; }
        .status-error { background: #ef4444; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Navigation */
        .nav-pills {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .nav-pill {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 25px;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .nav-pill:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            transform: translateY(-1px);
        }

        /* Cards */
        .card-clean {
            background: var(--gov-card);
            border: 1px solid var(--gov-border);
            border-radius: 12px;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }

        .card-clean:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }

        .card-header-clean {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-bottom: 1px solid var(--gov-border);
            padding: 1.25rem;
            border-radius: 12px 12px 0 0;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--gov-text);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-body-clean {
            padding: 1.5rem;
        }

        /* Statistics Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--gov-card);
            border: 1px solid var(--gov-border);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            line-height: 1;
        }

        .stat-label {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--gov-text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-high { color: var(--gov-accent); }
        .stat-medium { color: var(--gov-warning); }
        .stat-low { color: var(--gov-secondary); }
        .stat-info { color: var(--gov-primary); }

        /* Controls */
        .form-select, .form-control {
            border: 2px solid var(--gov-border);
            border-radius: 8px;
            padding: 0.75rem;
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }

        .form-select:focus, .form-control:focus {
            border-color: var(--gov-primary);
            box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
            outline: none;
        }

        .btn-gov {
            background: var(--gov-primary);
            border: none;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 0.75rem;
        }

        .btn-gov:hover {
            background: #1e3a8a;
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }

        .btn-gov-secondary {
            background: var(--gov-secondary);
        }

        .btn-gov-secondary:hover {
            background: #047857;
        }

        .btn-gov-warning {
            background: var(--gov-warning);
        }

        .btn-gov-warning:hover {
            background: #b45309;
        }

        .btn-gov-danger {
            background: var(--gov-accent);
        }

        .btn-gov-danger:hover {
            background: #b91c1c;
        }

        /* Map */
        #map {
            height: 500px;
            border-radius: 8px;
            border: 1px solid var(--gov-border);
        }

        /* Alerts */
        .alerts-container {
            max-height: 400px;
            overflow-y: auto;
        }

        .alert-item {
            background: var(--gov-card);
            border: 1px solid var(--gov-border);
            border-left: 4px solid var(--gov-warning);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            transition: all 0.3s ease;
        }

        .alert-item:hover {
            transform: translateX(3px);
            box-shadow: var(--shadow);
        }

        .alert-high { border-left-color: var(--gov-accent); }
        .alert-medium { border-left-color: var(--gov-warning); }
        .alert-low { border-left-color: var(--gov-secondary); }

        .alert-title {
            font-weight: 700;
            margin-bottom: 0.25rem;
            color: var(--gov-text);
        }

        .alert-meta {
            font-size: 0.85rem;
            color: var(--gov-text-light);
        }

        /* Progress */
        .progress {
            height: 8px;
            border-radius: 4px;
            background: #e2e8f0;
        }

        .progress-bar {
            border-radius: 4px;
            transition: width 0.6s ease;
        }

        /* Data Source Indicator */
        .data-source-bar {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--gov-primary);
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 25px;
            font-size: 0.85rem;
            font-weight: 600;
            z-index: 1000;
            box-shadow: var(--shadow-lg);
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .data-real { background: var(--gov-secondary); }
        .data-partial { background: var(--gov-warning); }
        .data-simulated { background: var(--gov-accent); }

        /* Loading */
        .loading-spinner {
            width: 24px;
            height: 24px;
            border: 2px solid var(--gov-border);
            border-top: 2px solid var(--gov-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .gov-title {
                font-size: 2rem;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .status-bar {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .data-source-bar {
                position: relative;
                top: auto;
                right: auto;
                margin-bottom: 1rem;
                text-align: center;
            }
        }

        /* Clean spacing */
        .section-spacing {
            margin-bottom: 2rem;
        }

        .mb-clean {
            margin-bottom: 1rem;
        }

        /* Risk Factors Analysis - Same as Manual Portal */
        .risk-factors-section {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid #e2e8f0;
        }

        .factors-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
        }

        .factor-item {
            background: white;
            border-radius: 12px;
            padding: 20px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }

        .factor-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .factor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .factor-name {
            font-weight: 600;
            color: var(--gov-text);
            font-size: 14px;
        }

        .factor-impact {
            font-weight: 700;
            font-size: 16px;
        }

        .impact-high { color: #ef4444; }
        .impact-medium { color: #f59e0b; }
        .impact-low { color: #10b981; }

        .factor-description {
            font-size: 13px;
            color: var(--gov-text-light);
            line-height: 1.4;
        }

        .factor-bar {
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            margin: 8px 0;
            overflow: hidden;
        }

        .factor-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.8s ease;
        }

        /* Clean typography */
        .text-clean {
            color: var(--gov-text);
            line-height: 1.5;
        }

        .text-muted-clean {
            color: var(--gov-text-light);
            font-size: 0.9rem;
        }
    </style>
</head>

<body>
    <!-- Data Source Indicator -->
    <div class="data-source-bar" id="dataSourceIndicator">
        <i class="fas fa-database"></i> Connecting to Real Data Sources...
    </div>

    <!-- Header -->
    <header class="gov-header">
        <div class="container">
            <div class="text-center">
                <h1 class="gov-title">
                    <i class="fas fa-shield-alt"></i>
                    Government Traffic Safety Portal
                </h1>
                <p class="gov-subtitle">
                    Real-time High Risk Area Analysis & Monitoring System
                </p>
                
                <!-- Status Bar -->
                <div class="status-bar">
                    <div class="status-item">
                        <span class="status-dot status-live" id="dataStatusDot"></span>
                        <span id="dataStatusText">Real Data: Connecting...</span>
                    </div>
                    <div class="status-item">
                        <span class="status-dot status-live" id="weatherStatusDot"></span>
                        <span id="weatherStatusText">Weather API: Active</span>
                    </div>
                    <div class="status-item">
                        <span class="status-dot status-live" id="aiStatusDot"></span>
                        <span id="aiStatusText">AI Analysis: Ready</span>
                    </div>
                </div>
                
                <!-- Navigation -->
                <div class="nav-pills">
                    <a href="/dashboard" class="nav-pill">
                        <i class="fas fa-th-large"></i> Main Dashboard
                    </a>
                    <a href="/" class="nav-pill">
                        <i class="fas fa-calculator"></i> Manual Prediction
                    </a>
                    <a href="/heatmap" class="nav-pill">
                        <i class="fas fa-traffic-light"></i> Live Traffic
                    </a>
                    <a href="/historical-dashboard" class="nav-pill">
                        <i class="fas fa-chart-line"></i> Analytics
                    </a>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Statistics Dashboard -->
        <div class="stats-grid section-spacing">
            <div class="stat-card">
                <div class="stat-number stat-high" id="highRiskCount">0</div>
                <div class="stat-label">Critical Risk Zones</div>
            </div>
            <div class="stat-card">
                <div class="stat-number stat-medium" id="mediumRiskCount">0</div>
                <div class="stat-label">Medium Risk Areas</div>
            </div>
            <div class="stat-card">
                <div class="stat-number stat-low" id="lowRiskCount">0</div>
                <div class="stat-label">Safe Zones</div>
            </div>
            <div class="stat-card">
                <div class="stat-number stat-info" id="totalAnalyzed">0</div>
                <div class="stat-label">Areas Analyzed</div>
            </div>
        </div>

        <div class="row g-4">
            <!-- Control Panel -->
            <div class="col-lg-4">
                <!-- City Selection -->
                <div class="card-clean mb-clean">
                    <div class="card-header-clean">
                        <h5 class="card-title">
                            <i class="fas fa-map-marker-alt text-primary"></i>
                            City Analysis
                        </h5>
                    </div>
                    <div class="card-body-clean">
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Select City</label>
                            <select class="form-select" id="citySelect">
                                <optgroup label="Tier 1 Cities">
                                    <option value="mumbai">Mumbai - Financial Capital</option>
                                    <option value="delhi">Delhi - National Capital</option>
                                    <option value="bangalore">Bangalore - IT Hub</option>
                                    <option value="chennai">Chennai - Industrial Center</option>
                                    <option value="kolkata">Kolkata - Cultural Capital</option>
                                    <option value="hyderabad">Hyderabad - Cyberabad</option>
                                    <option value="pune">Pune - Educational Hub</option>
                                    <option value="ahmedabad">Ahmedabad - Commercial Center</option>
                                </optgroup>
                                <optgroup label="Tier 2 Cities">
                                    <option value="jaipur">Jaipur - Pink City</option>
                                    <option value="lucknow">Lucknow - City of Nawabs</option>
                                    <option value="kanpur">Kanpur - Industrial Hub</option>
                                    <option value="nagpur">Nagpur - Orange City</option>
                                    <option value="indore">Indore - Commercial Capital of MP</option>
                                    <option value="thane">Thane - City of Lakes</option>
                                    <option value="bhopal">Bhopal - City of Lakes</option>
                                    <option value="visakhapatnam">Visakhapatnam - Steel City</option>
                                    <option value="patna">Patna - Ancient Capital</option>
                                    <option value="vadodara">Vadodara - Cultural Capital of Gujarat</option>
                                    <option value="ludhiana">Ludhiana - Manchester of India</option>
                                    <option value="agra">Agra - City of Taj</option>
                                    <option value="nashik">Nashik - Wine Capital</option>
                                    <option value="faridabad">Faridabad - Industrial City</option>
                                    <option value="meerut">Meerut - Sports City</option>
                                    <option value="rajkot">Rajkot - Commercial Hub</option>
                                </optgroup>
                                <optgroup label="Tier 3 Cities">
                                    <option value="aurangabad">Aurangabad - Tourism Hub</option>
                                    <option value="dhanbad">Dhanbad - Coal Capital</option>
                                    <option value="amritsar">Amritsar - Holy City</option>
                                    <option value="allahabad">Allahabad - Sangam City</option>
                                    <option value="ranchi">Ranchi - City of Waterfalls</option>
                                    <option value="coimbatore">Coimbatore - Textile Hub</option>
                                    <option value="jabalpur">Jabalpur - Marble City</option>
                                    <option value="gwalior">Gwalior - Historic City</option>
                                    <option value="vijayawada">Vijayawada - Business Capital of AP</option>
                                    <option value="jodhpur">Jodhpur - Blue City</option>
                                    <option value="madurai">Madurai - Temple City</option>
                                    <option value="raipur">Raipur - Rice Bowl</option>
                                    <option value="kota">Kota - Education Hub</option>
                                    <option value="chandigarh">Chandigarh - City Beautiful</option>
                                    <option value="guwahati">Guwahati - Gateway to Northeast</option>
                                    <option value="mysore">Mysore - Cultural Capital</option>
                                    <option value="mangalore">Mangalore - Port City</option>
                                    <option value="hubli">Hubli-Dharwad - Twin Cities</option>
                                    <option value="belgaum">Belgaum - Border City</option>
                                    <option value="gulbarga">Gulbarga - Historic City</option>
                                    <option value="davangere">Davangere - Cotton City</option>
                                    <option value="bellary">Bellary - Iron Ore Hub</option>
                                    <option value="bijapur">Bijapur - Architectural Marvel</option>
                                    <option value="shimoga">Shimoga - Gateway to Malnad</option>
                                    <option value="tumkur">Tumkur - Educational Hub</option>
                                    <option value="bareilly">Bareilly - Furniture Hub</option>
                                    <option value="aligarh">Aligarh - Lock City</option>
                                    <option value="jalandhar">Jalandhar - Sports Goods Hub</option>
                                </optgroup>
                            </select>
                        </div>
                        <button class="btn-gov" onclick="analyzeCity()">
                            <i class="fas fa-search"></i> Analyze High Risk Areas
                        </button>
                    </div>
                </div>

                <!-- High Risk Areas Dropdown -->
                <div class="card-clean mb-clean">
                    <div class="card-header-clean">
                        <h5 class="card-title">
                            <i class="fas fa-exclamation-triangle text-danger"></i>
                            High Risk Areas
                        </h5>
                    </div>
                    <div class="card-body-clean">
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Select High Risk Zone</label>
                            <select class="form-select" id="highRiskAreasSelect">
                                <option value="">Loading high risk areas...</option>
                            </select>
                        </div>
                        <button class="btn-gov btn-gov-danger" onclick="focusOnRiskArea()">
                            <i class="fas fa-crosshairs"></i> Focus on Selected Area
                        </button>

                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="card-clean mb-clean">
                    <div class="card-header-clean">
                        <h5 class="card-title">
                            <i class="fas fa-tools text-primary"></i>
                            Analysis Tools
                        </h5>
                    </div>
                    <div class="card-body-clean">
                        <button class="btn-gov btn-gov-warning" onclick="generateReport()">
                            <i class="fas fa-file-alt"></i> Generate Safety Report
                        </button>
                        <button class="btn-gov btn-gov-secondary" onclick="exportData()">
                            <i class="fas fa-download"></i> Export Analysis Data
                        </button>
                    </div>
                </div>

                <!-- Real-time Alerts -->
                <div class="card-clean">
                    <div class="card-header-clean">
                        <h5 class="card-title">
                            <i class="fas fa-bell text-danger"></i>
                            Live Risk Alerts
                        </h5>
                    </div>
                    <div class="card-body-clean">
                        <div class="alerts-container" id="alertsContainer">
                            <div class="text-center">
                                <div class="loading-spinner"></div>
                                <p class="text-muted-clean mt-2">Loading real-time alerts...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Map and Analysis -->
            <div class="col-lg-8">
                <!-- Map -->
                <div class="card-clean mb-clean">
                    <div class="card-header-clean">
                        <h5 class="card-title">
                            <i class="fas fa-map text-success"></i>
                            Real-time Risk Monitoring Map
                        </h5>
                    </div>
                    <div class="card-body-clean">
                        <div id="map"></div>
                    </div>
                </div>

                <!-- Analysis Summary -->
                <div class="card-clean">
                    <div class="card-header-clean">
                        <h5 class="card-title">
                            <i class="fas fa-chart-bar text-info"></i>
                            Risk Analysis Summary
                        </h5>
                    </div>
                    <div class="card-body-clean">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="fw-bold mb-2">Overall Risk Level</h6>
                                <div class="progress mb-2">
                                    <div class="progress-bar bg-warning" id="overallRiskBar" style="width: 0%"></div>
                                </div>
                                <small class="text-muted-clean">Based on real accident data analysis</small>
                            </div>
                            <div class="col-md-6">
                                <h6 class="fw-bold mb-2">City Safety Score</h6>
                                <div class="display-6 text-success fw-bold" id="safetyScore">85%</div>
                                <small class="text-muted-clean">Real-time safety rating</small>
                            </div>
                        </div>
                        
                        <hr class="my-4">
                        
                        <!-- Risk Factors Analysis -->
                        <div class="risk-factors-section" id="riskFactorsSection" style="display: none;">
                            <h4 class="mb-3">
                                <i class="fas fa-chart-pie"></i> Government Risk Factor Analysis
                            </h4>
                            <div class="factors-grid" id="factorsGrid">
                                <!-- Factors will be populated here -->
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="fw-bold mb-3">Primary Risk Factors</h6>
                                <ul class="list-unstyled" id="riskFactorsList">
                                    <li class="mb-2">
                                        <i class="fas fa-circle text-warning me-2" style="font-size: 0.5rem;"></i>
                                        Analyzing real traffic data...
                                    </li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6 class="fw-bold mb-3">Immediate Actions</h6>
                                <ul class="list-unstyled" id="actionsList">
                                    <li class="mb-2">
                                        <i class="fas fa-circle text-info me-2" style="font-size: 0.5rem;"></i>
                                        Loading recommendations...
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // Global variables
        let map;
        let markers = [];
        let currentCity = 'mumbai';
        let highRiskAreas = [];
        let selectedRiskArea = null;
        
        // City data with real coordinates
        const cities = {
            // Tier 1 Cities
            mumbai: { lat: 19.0760, lng: 72.8777, name: 'Mumbai', population: '12.5M' },
            delhi: { lat: 28.7041, lng: 77.1025, name: 'Delhi', population: '11.0M' },
            bangalore: { lat: 12.9716, lng: 77.5946, name: 'Bangalore', population: '8.4M' },
            chennai: { lat: 13.0827, lng: 80.2707, name: 'Chennai', population: '7.1M' },
            kolkata: { lat: 22.5726, lng: 88.3639, name: 'Kolkata', population: '4.5M' },
            hyderabad: { lat: 17.3850, lng: 78.4867, name: 'Hyderabad', population: '6.9M' },
            pune: { lat: 18.5204, lng: 73.8567, name: 'Pune', population: '3.1M' },
            ahmedabad: { lat: 23.0225, lng: 72.5714, name: 'Ahmedabad', population: '5.6M' },
            
            // Tier 2 Cities
            jaipur: { lat: 26.9124, lng: 75.7873, name: 'Jaipur', population: '3.1M' },
            lucknow: { lat: 26.8467, lng: 80.9462, name: 'Lucknow', population: '2.8M' },
            kanpur: { lat: 26.4499, lng: 80.3319, name: 'Kanpur', population: '2.7M' },
            nagpur: { lat: 21.1458, lng: 79.0882, name: 'Nagpur', population: '2.4M' },
            indore: { lat: 22.7196, lng: 75.8577, name: 'Indore', population: '2.2M' },
            thane: { lat: 19.2183, lng: 72.9781, name: 'Thane', population: '1.8M' },
            bhopal: { lat: 23.2599, lng: 77.4126, name: 'Bhopal', population: '1.8M' },
            visakhapatnam: { lat: 17.6868, lng: 83.2185, name: 'Visakhapatnam', population: '1.7M' },
            patna: { lat: 25.5941, lng: 85.1376, name: 'Patna', population: '1.7M' },
            vadodara: { lat: 22.3072, lng: 73.1812, name: 'Vadodara', population: '1.7M' },
            ludhiana: { lat: 30.9010, lng: 75.8573, name: 'Ludhiana', population: '1.6M' },
            agra: { lat: 27.1767, lng: 78.0081, name: 'Agra', population: '1.6M' },
            nashik: { lat: 19.9975, lng: 73.7898, name: 'Nashik', population: '1.5M' },
            faridabad: { lat: 28.4089, lng: 77.3178, name: 'Faridabad', population: '1.4M' },
            meerut: { lat: 28.9845, lng: 77.7064, name: 'Meerut', population: '1.3M' },
            rajkot: { lat: 22.3039, lng: 70.8022, name: 'Rajkot', population: '1.3M' },
            
            // Tier 3 Cities
            aurangabad: { lat: 19.8762, lng: 75.3433, name: 'Aurangabad', population: '1.2M' },
            dhanbad: { lat: 23.7957, lng: 86.4304, name: 'Dhanbad', population: '1.2M' },
            amritsar: { lat: 31.6340, lng: 74.8723, name: 'Amritsar', population: '1.1M' },
            allahabad: { lat: 25.4358, lng: 81.8463, name: 'Allahabad', population: '1.1M' },
            ranchi: { lat: 23.3441, lng: 85.3096, name: 'Ranchi', population: '1.1M' },
            coimbatore: { lat: 11.0168, lng: 76.9558, name: 'Coimbatore', population: '1.1M' },
            jabalpur: { lat: 23.1815, lng: 79.9864, name: 'Jabalpur', population: '1.1M' },
            gwalior: { lat: 26.2183, lng: 78.1828, name: 'Gwalior', population: '1.1M' },
            vijayawada: { lat: 16.5062, lng: 80.6480, name: 'Vijayawada', population: '1.0M' },
            jodhpur: { lat: 26.2389, lng: 73.0243, name: 'Jodhpur', population: '1.0M' },
            madurai: { lat: 9.9252, lng: 78.1198, name: 'Madurai', population: '1.0M' },
            raipur: { lat: 21.2514, lng: 81.6296, name: 'Raipur', population: '1.0M' },
            kota: { lat: 25.2138, lng: 75.8648, name: 'Kota', population: '1.0M' },
            chandigarh: { lat: 30.7333, lng: 76.7794, name: 'Chandigarh', population: '1.0M' },
            guwahati: { lat: 26.1445, lng: 91.7362, name: 'Guwahati', population: '0.96M' },
            mysore: { lat: 12.2958, lng: 76.6394, name: 'Mysore', population: '0.89M' },
            mangalore: { lat: 12.9141, lng: 74.8560, name: 'Mangalore', population: '0.62M' },
            hubli: { lat: 15.3647, lng: 75.1240, name: 'Hubli-Dharwad', population: '0.94M' },
            belgaum: { lat: 15.8497, lng: 74.4977, name: 'Belgaum', population: '0.61M' },
            gulbarga: { lat: 17.3297, lng: 76.8343, name: 'Gulbarga', population: '0.53M' },
            davangere: { lat: 14.4644, lng: 75.9218, name: 'Davangere', population: '0.43M' },
            bellary: { lat: 15.1394, lng: 76.9214, name: 'Bellary', population: '0.41M' },
            bijapur: { lat: 16.8302, lng: 75.7100, name: 'Bijapur', population: '0.33M' },
            shimoga: { lat: 13.9299, lng: 75.5681, name: 'Shimoga', population: '0.32M' },
            tumkur: { lat: 13.3379, lng: 77.1022, name: 'Tumkur', population: '0.31M' },
            bareilly: { lat: 28.3670, lng: 79.4304, name: 'Bareilly', population: '0.90M' },
            aligarh: { lat: 27.8974, lng: 78.0880, name: 'Aligarh', population: '0.87M' },
            jalandhar: { lat: 31.3260, lng: 75.5762, name: 'Jalandhar', population: '0.87M' }
        };

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            initializeMap();
            updateDataSourceIndicator('connecting', 'Connecting to Real Data Sources...');
            
            // Auto-analyze Mumbai on load
            setTimeout(() => {
                analyzeCity();
            }, 1000);
        });

        function initializeMap() {
            map = L.map('map').setView([19.0760, 72.8777], 11);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 18,
                attribution: '© OpenStreetMap | Government Safety Portal'
            }).addTo(map);
        }

        async function analyzeCity() {
            const cityKey = document.getElementById('citySelect').value;
            const city = cities[cityKey];
            currentCity = cityKey;
            
            // Update map view
            map.setView([city.lat, city.lng], 11);
            
            // Clear existing markers
            clearMarkers();
            
            // Show loading state
            showLoadingAlerts(`Analyzing ${city.name} using real data sources...`);
            updateDataSourceIndicator('loading', 'Fetching Real Accident Data...');
            
            try {
                // Priority 1: Try to get real accident data
                let realData = await fetchRealAccidentData(city.lat, city.lng, 10);
                
                if (realData && realData.length > 0) {
                    updateDataSourceIndicator('real', `Real Data: ${realData.length} accidents found`);
                    await processRealData(realData, city);
                } else {
                    // Priority 2: Try AI predictions with real weather
                    updateDataSourceIndicator('partial', 'Real data limited - Using AI + Real Weather');
                    await processAIData(city);
                }
                
            } catch (error) {
                console.error('Analysis failed:', error);
                updateDataSourceIndicator('error', 'Real data unavailable - Using simulated analysis');
                await processSimulatedData(city);
            }
        }

        async function fetchRealAccidentData(lat, lng, radius) {
            try {
                // Try multiple real data sources in priority order
                
                // Source 1: Government accident database
                const govResponse = await fetch('/get_indian_accident_data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ lat, lon: lng, radius })
                });
                
                if (govResponse.ok) {
                    const govData = await govResponse.json();
                    if (govData.success && govData.data && govData.data.length > 0) {
                        console.log(`Real government data: ${govData.data.length} accidents`);
                        return govData.data;
                    }
                }
                
                // Source 2: Global accident database
                const globalResponse = await fetch('/get_global_accident_data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ lat, lon: lng, radius })
                });
                
                if (globalResponse.ok) {
                    const globalData = await globalResponse.json();
                    if (globalData.success && globalData.data && globalData.data.length > 0) {
                        console.log(`Real global data: ${globalData.data.length} accidents`);
                        return globalData.data;
                    }
                }
                
                return null;
                
            } catch (error) {
                console.error('Real data fetch failed:', error);
                return null;
            }
        }

        async function processRealData(accidents, city) {
            let highRisk = 0, mediumRisk = 0, lowRisk = 0;
            const alerts = [];
            
            accidents.forEach(accident => {
                const severity = accident.severity || 2;
                const riskLevel = severity >= 3 ? 'high' : (severity >= 2 ? 'medium' : 'low');
                
                if (riskLevel === 'high') {
                    highRisk++;
                    alerts.push({
                        type: 'high',
                        title: 'Critical Risk Zone Detected',
                        location: `${accident.latitude?.toFixed(4)}, ${accident.longitude?.toFixed(4)}`,
                        source: accident.source || 'Government Database',
                        time: new Date().toLocaleTimeString()
                    });
                } else if (riskLevel === 'medium') {
                    mediumRisk++;
                } else {
                    lowRisk++;
                }
                
                // Add marker to map
                addRiskMarker(accident.latitude, accident.longitude, riskLevel, {
                    title: `Real Accident Data`,
                    details: `Severity: ${severity}/3`,
                    source: accident.source || 'Government Database',
                    city: accident.city || city.name
                });
            });
            
            updateStatistics(highRisk, mediumRisk, lowRisk, accidents.length);
            updateAnalysisSummary(highRisk, mediumRisk, lowRisk, accidents.length, city, 'real');
            displayGovRiskFactors(accidents, city);
            updateHighRiskAreasDropdown(accidents.filter(acc => acc.severity >= 3), city);
            displayAlerts(alerts, city);
        }

        async function processAIData(city) {
            const testPoints = generateTestPoints(city, 8);
            let highRisk = 0, mediumRisk = 0, lowRisk = 0;
            const alerts = [];
            
            for (const point of testPoints) {
                try {
                    const prediction = await getAIPrediction(point.lat, point.lng);
                    const riskLevel = categorizeRisk(prediction.risk_value);
                    
                    if (riskLevel === 'high') {
                        highRisk++;
                        alerts.push({
                            type: 'high',
                            title: 'AI Detected High Risk Area',
                            location: `${point.lat.toFixed(4)}, ${point.lng.toFixed(4)}`,
                            source: 'AI Analysis + Real Weather',
                            time: new Date().toLocaleTimeString()
                        });
                    } else if (riskLevel === 'medium') {
                        mediumRisk++;
                    } else {
                        lowRisk++;
                    }
                    
                    addRiskMarker(point.lat, point.lng, riskLevel, {
                        title: 'AI Risk Prediction',
                        details: `Risk Score: ${prediction.risk_value}`,
                        source: 'AI Analysis',
                        confidence: `${prediction.confidence}%`
                    });
                    
                } catch (error) {
                    console.error('AI prediction failed:', error);
                }
            }
            
            updateStatistics(highRisk, mediumRisk, lowRisk, testPoints.length);
            updateAnalysisSummary(highRisk, mediumRisk, lowRisk, testPoints.length, city, 'ai');
            displayGovRiskFactors(testPoints, city);
            updateHighRiskAreasDropdown(testPoints.filter(p => categorizeRisk(p.risk_value || 3.5) === 'high'), city);
            displayAlerts(alerts, city);
        }

        async function processSimulatedData(city) {
            // Fallback to simulated data based on city characteristics
            const cityRiskProfile = getCityRiskProfile(city.name);
            const points = generateTestPoints(city, 6);
            
            let highRisk = cityRiskProfile.high;
            let mediumRisk = cityRiskProfile.medium;
            let lowRisk = cityRiskProfile.low;
            
            const alerts = [{
                type: 'medium',
                title: 'Simulated Risk Analysis',
                location: `${city.name} City Center`,
                source: 'Simulated Data',
                time: new Date().toLocaleTimeString()
            }];
            
            // Add simulated markers
            points.forEach((point, index) => {
                const riskLevel = index < highRisk ? 'high' : (index < highRisk + mediumRisk ? 'medium' : 'low');
                addRiskMarker(point.lat, point.lng, riskLevel, {
                    title: 'Simulated Risk Zone',
                    details: 'Based on city characteristics',
                    source: 'Simulation'
                });
            });
            
            updateStatistics(highRisk, mediumRisk, lowRisk, points.length);
            updateAnalysisSummary(highRisk, mediumRisk, lowRisk, points.length, city, 'simulated');
            displayGovRiskFactors(points, city);
            updateHighRiskAreasDropdown(points.slice(0, highRisk), city);
            displayAlerts(alerts, city);
        }

        function getCityRiskProfile(cityName) {
            const profiles = {
                'Mumbai': { high: 3, medium: 2, low: 1 },
                'Delhi': { high: 4, medium: 1, low: 1 },
                'Bangalore': { high: 2, medium: 3, low: 1 },
                'Chennai': { high: 2, medium: 2, low: 2 },
                'Kolkata': { high: 2, medium: 2, low: 2 },
                'Hyderabad': { high: 1, medium: 3, low: 2 },
                'Pune': { high: 1, medium: 2, low: 3 },
                'Ahmedabad': { high: 1, medium: 2, low: 3 }
            };
            return profiles[cityName] || { high: 1, medium: 2, low: 3 };
        }

        function generateTestPoints(city, count) {
            const points = [];
            for (let i = 0; i < count; i++) {
                const angle = (i / count) * 2 * Math.PI;
                const distance = 0.02 + Math.random() * 0.03;
                points.push({
                    lat: city.lat + Math.cos(angle) * distance,
                    lng: city.lng + Math.sin(angle) * distance
                });
            }
            return points;
        }

        async function getAIPrediction(lat, lng) {
            const response = await fetch('/predict_risk', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    latitude: lat,
                    longitude: lng,
                    hour: new Date().getHours(),
                    day_of_week: new Date().getDay() + 1,
                    weather_conditions: Math.floor(Math.random() * 3) + 1,
                    speed_limit: [30, 40, 50, 60][Math.floor(Math.random() * 4)]
                })
            });
            return await response.json();
        }

        function categorizeRisk(riskValue) {
            if (riskValue >= 3.5) return 'high';
            if (riskValue >= 2.5) return 'medium';
            return 'low';
        }

        function addRiskMarker(lat, lng, riskLevel, info) {
            const colors = { high: '#dc2626', medium: '#d97706', low: '#059669' };
            const color = colors[riskLevel];
            
            const marker = L.circleMarker([lat, lng], {
                radius: riskLevel === 'high' ? 12 : (riskLevel === 'medium' ? 9 : 6),
                fillColor: color,
                color: '#ffffff',
                weight: 2,
                opacity: 1,
                fillOpacity: 0.8
            }).addTo(map);
            
            marker.bindPopup(`
                <div style="font-family: Inter, sans-serif;">
                    <h6 style="color: ${color}; margin-bottom: 8px;">
                        <i class="fas fa-exclamation-triangle"></i> ${riskLevel.toUpperCase()} RISK
                    </h6>
                    <p><strong>${info.title}</strong></p>
                    <p>${info.details}</p>
                    <small>Source: ${info.source}</small>
                    ${info.confidence ? `<br><small>Confidence: ${info.confidence}</small>` : ''}
                </div>
            `);
            
            markers.push(marker);
        }

        function clearMarkers() {
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
        }

        function updateStatistics(high, medium, low, total) {
            document.getElementById('highRiskCount').textContent = high;
            document.getElementById('mediumRiskCount').textContent = medium;
            document.getElementById('lowRiskCount').textContent = low;
            document.getElementById('totalAnalyzed').textContent = total;
        }

        function updateAnalysisSummary(high, medium, low, total, city, dataType) {
            // Update risk bar
            const riskPercentage = total > 0 ? (high / total) * 100 : 0;
            const riskBar = document.getElementById('overallRiskBar');
            riskBar.style.width = riskPercentage + '%';
            
            if (riskPercentage > 40) {
                riskBar.className = 'progress-bar bg-danger';
            } else if (riskPercentage > 20) {
                riskBar.className = 'progress-bar bg-warning';
            } else {
                riskBar.className = 'progress-bar bg-success';
            }
            
            // Update safety score
            const safetyScore = Math.max(0, Math.round(100 - (riskPercentage * 1.5)));
            document.getElementById('safetyScore').textContent = safetyScore + '%';
            
            // Update risk factors
            const riskFactors = [
                'Peak hour traffic congestion (7-10 AM, 5-8 PM)',
                'Weather-related visibility and road conditions',
                'High-density intersection complexity',
                'Speed limit compliance variations',
                'Pedestrian crossing safety measures'
            ];
            
            document.getElementById('riskFactorsList').innerHTML = riskFactors
                .map(factor => `<li class="mb-2"><i class="fas fa-circle text-warning me-2" style="font-size: 0.5rem;"></i>${factor}</li>`)
                .join('');
            
            // Update actions
            const actions = [
                'Deploy additional traffic personnel during peak hours',
                'Enhance real-time monitoring systems',
                'Coordinate with emergency response teams',
                'Issue public safety advisories',
                'Implement dynamic traffic management'
            ];
            
            document.getElementById('actionsList').innerHTML = actions
                .map(action => `<li class="mb-2"><i class="fas fa-circle text-info me-2" style="font-size: 0.5rem;"></i>${action}</li>`)
                .join('');
        }

        function displayAlerts(alerts, city) {
            const container = document.getElementById('alertsContainer');
            
            if (alerts.length === 0) {
                container.innerHTML = `
                    <div class="alert-item alert-low">
                        <div class="alert-title">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            All Systems Normal
                        </div>
                        <div class="alert-meta">No critical alerts for ${city.name} • ${new Date().toLocaleTimeString()}</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = alerts.map(alert => `
                <div class="alert-item alert-${alert.type}">
                    <div class="alert-title">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        ${alert.title}
                    </div>
                    <div class="alert-meta">
                        ${alert.location} • ${alert.time}<br>
                        <small>Source: ${alert.source}</small>
                    </div>
                </div>
            `).join('');
        }

        function showLoadingAlerts(message) {
            const container = document.getElementById('alertsContainer');
            container.innerHTML = `
                <div class="text-center">
                    <div class="loading-spinner"></div>
                    <p class="text-muted-clean mt-2">${message}</p>
                </div>
            `;
        }

        function updateDataSourceIndicator(status, message) {
            const indicator = document.getElementById('dataSourceIndicator');
            const dataStatusDot = document.getElementById('dataStatusDot');
            const dataStatusText = document.getElementById('dataStatusText');
            
            indicator.className = 'data-source-bar';
            dataStatusDot.className = 'status-dot';
            
            switch(status) {
                case 'real':
                    indicator.classList.add('data-real');
                    dataStatusDot.classList.add('status-live');
                    dataStatusText.textContent = 'Real Data: Active';
                    break;
                case 'partial':
                    indicator.classList.add('data-partial');
                    dataStatusDot.classList.add('status-partial');
                    dataStatusText.textContent = 'Mixed Data: Partial Real';
                    break;
                case 'error':
                    indicator.classList.add('data-simulated');
                    dataStatusDot.classList.add('status-error');
                    dataStatusText.textContent = 'Simulated Data: Fallback';
                    break;
                default:
                    dataStatusDot.classList.add('status-partial');
                    dataStatusText.textContent = 'Connecting...';
            }
            
            indicator.innerHTML = `<i class="fas fa-database"></i> ${message}`;
        }

        // Action Functions
        function emergencyAlert() {
            const city = cities[currentCity];
            const highRisk = document.getElementById('highRiskCount').textContent;
            
            alert(`🚨 EMERGENCY PROTOCOL ACTIVATED\n\n📍 Location: ${city.name}\n⚠️ Critical Risk Zones: ${highRisk}\n⏰ Time: ${new Date().toLocaleString()}\n\n🚨 IMMEDIATE ACTIONS:\n• All traffic units notified\n• Emergency services on standby\n• Public alert system activated\n• Real-time monitoring enhanced\n\n📞 Emergency Contacts:\n• Traffic Control: 100\n• Emergency Services: 108\n• Municipal Control: 1077`);
        }

        function generateReport() {
            const city = cities[currentCity];
            const stats = {
                high: document.getElementById('highRiskCount').textContent,
                medium: document.getElementById('mediumRiskCount').textContent,
                low: document.getElementById('lowRiskCount').textContent,
                total: document.getElementById('totalAnalyzed').textContent,
                safety: document.getElementById('safetyScore').textContent
            };
            
            alert(`📋 OFFICIAL SAFETY REPORT\n\n🏛️ Government Traffic Safety Portal\n📅 Generated: ${new Date().toLocaleDateString()}\n🏙️ City: ${city.name} (${city.population})\n\n📊 ANALYSIS SUMMARY:\n• Total Areas: ${stats.total}\n• Critical Risk: ${stats.high}\n• Medium Risk: ${stats.medium}\n• Safe Zones: ${stats.low}\n• Safety Score: ${stats.safety}\n\n🎯 RECOMMENDATIONS:\n• Enhanced monitoring during peak hours\n• Weather-responsive traffic management\n• Emergency response coordination\n• Public safety awareness campaigns\n\n✅ Report ready for official distribution`);
        }

        function exportData() {
            const city = cities[currentCity];
            alert(`📤 DATA EXPORT INITIATED\n\n📊 Export Package: ${city.name}\n🔐 Security: Government Grade\n📋 Formats: CSV, JSON, PDF, XML\n\n📈 Contents:\n• Real accident data analysis\n• Risk assessment matrices\n• Geographic coordinates\n• Statistical summaries\n• Weather correlations\n\n⏱️ Processing: 2-3 minutes\n📧 Delivery: Secure portal\n📋 Reference: GOV-${Date.now()}`);
        }

        function updateHighRiskAreasDropdown(riskAreas, city) {
            const dropdown = document.getElementById('highRiskAreasSelect');
            highRiskAreas = [];
            
            if (!riskAreas || riskAreas.length === 0) {
                dropdown.innerHTML = '<option value="">No high risk areas detected</option>';
                return;
            }
            
            // Generate specific area names based on coordinates and city
            const areaNames = generateAreaNames(riskAreas, city);
            
            dropdown.innerHTML = '<option value="">Select a high risk area...</option>';
            
            areaNames.forEach((area, index) => {
                highRiskAreas.push({
                    id: index,
                    name: area.name,
                    lat: area.lat,
                    lng: area.lng,
                    severity: area.severity,
                    description: area.description
                });
                
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `🚨 ${area.name} - ${area.description}`;
                dropdown.appendChild(option);
            });
        }
        
        function generateAreaNames(riskAreas, city) {
            const citySpecificAreas = {
                'Mumbai': [
                    'Dadar Junction', 'Bandra-Kurla Complex', 'Andheri East', 'Lower Parel',
                    'Worli Sea Link', 'Mahim Causeway', 'Sion Circle', 'King Circle',
                    'Chembur Naka', 'Ghatkopar Junction', 'Mulund Check Naka', 'Thane Creek Bridge'
                ],
                'Delhi': [
                    'Connaught Place', 'ITO Junction', 'AIIMS Flyover', 'Dhaula Kuan',
                    'Lajpat Nagar', 'Karol Bagh', 'Rajouri Garden', 'Laxmi Nagar',
                    'Mayur Vihar', 'Dwarka Sector 21', 'Rohini Sector 3', 'Janakpuri West'
                ],
                'Bangalore': [
                    'Silk Board Junction', 'Electronic City Toll', 'Hebbal Flyover', 'Tin Factory',
                    'Marathahalli Bridge', 'Whitefield Main Road', 'Koramangala 5th Block', 'Indiranagar 100 Feet Road',
                    'Jayanagar 4th Block', 'Banashankari 3rd Stage', 'Rajajinagar 2nd Block', 'Malleswaram Circle'
                ],
                'Chennai': [
                    'Anna Salai Junction', 'Kathipara Junction', 'Guindy Junction', 'Vadapalani Junction',
                    'T. Nagar Pondy Bazaar', 'Adyar Signal', 'Velachery Junction', 'Tambaram Sanatorium',
                    'Chrompet Junction', 'Pallavaram Junction', 'GST Road Toll', 'OMR Thoraipakkam'
                ],
                'Kolkata': [
                    'Howrah Bridge', 'Sealdah Junction', 'Park Circus', 'Gariahat Junction',
                    'Rashbehari Connector', 'Jadavpur 8B Stand', 'Garia Station Road', 'New Town Action Area',
                    'Salt Lake Sector V', 'Dumdum Junction', 'Barasat Junction', 'Barrackpore Trunk Road'
                ],
                'Hyderabad': [
                    'HITEC City Junction', 'Gachibowli Junction', 'Kukatpally Junction', 'Secunderabad Junction',
                    'Begumpet Junction', 'Ameerpet Junction', 'LB Nagar Junction', 'Uppal Junction',
                    'Miyapur Junction', 'SR Nagar Junction', 'Kondapur Junction', 'Madhapur Junction'
                ],
                'Pune': [
                    'Hinjewadi IT Park', 'Baner Junction', 'Aundh Junction', 'Shivajinagar Junction',
                    'Koregaon Park', 'Viman Nagar', 'Hadapsar Junction', 'Kothrud Junction',
                    'Warje Junction', 'Katraj Junction', 'Sinhgad Road', 'Wakad Junction'
                ],
                'Ahmedabad': [
                    'CG Road Junction', 'SG Highway', 'Satellite Junction', 'Vastrapur Junction',
                    'Bopal Junction', 'Prahlad Nagar', 'Ambawadi Junction', 'Navrangpura Junction',
                    'Maninagar Junction', 'Naroda Junction', 'Vatva Junction', 'Sarkhej Junction'
                ]
            };
            
            const areas = citySpecificAreas[city.name] || [
                'City Center Junction', 'Main Highway', 'Industrial Area', 'Commercial District',
                'Residential Zone', 'Market Area', 'Station Road', 'Bus Stand Area'
            ];
            
            return riskAreas.map((area, index) => {
                const areaName = areas[index % areas.length];
                const severity = area.severity || (area.risk_value ? Math.ceil(area.risk_value) : 3);
                
                let description;
                if (severity >= 4) {
                    description = 'Critical Risk Zone';
                } else if (severity >= 3) {
                    description = 'High Risk Area';
                } else {
                    description = 'Elevated Risk Zone';
                }
                
                return {
                    name: areaName,
                    lat: area.latitude || area.lat,
                    lng: area.longitude || area.lng,
                    severity: severity,
                    description: description
                };
            });
        }
        
        function focusOnRiskArea() {
            const dropdown = document.getElementById('highRiskAreasSelect');
            const selectedIndex = dropdown.value;
            
            if (!selectedIndex || selectedIndex === '') {
                alert('Please select a high risk area from the dropdown first.');
                return;
            }
            
            const area = highRiskAreas[selectedIndex];
            selectedRiskArea = area;
            
            // Focus map on selected area
            map.setView([area.lat, area.lng], 15);
            
            // Highlight the area with a special marker
            const highlightMarker = L.circleMarker([area.lat, area.lng], {
                radius: 20,
                fillColor: '#dc2626',
                color: '#ffffff',
                weight: 4,
                opacity: 1,
                fillOpacity: 0.3,
                className: 'pulse-marker'
            }).addTo(map);
            
            highlightMarker.bindPopup(`
                <div style="font-family: Inter, sans-serif; min-width: 250px;">
                    <h6 style="color: #dc2626; margin-bottom: 10px; font-weight: 700;">
                        🚨 FOCUSED HIGH RISK AREA
                    </h6>
                    <p><strong>Location:</strong> ${area.name}</p>
                    <p><strong>Risk Level:</strong> ${area.description}</p>
                    <p><strong>Severity:</strong> ${area.severity}/5</p>
                    <p><strong>Coordinates:</strong> ${area.lat.toFixed(4)}, ${area.lng.toFixed(4)}</p>
                    <hr style="margin: 10px 0;">
                    <p style="font-size: 12px; color: #666;">
                        <i class="fas fa-shield-alt"></i> Government Priority Area
                    </p>
                </div>
            `).openPopup();
            
            // Add pulse animation CSS
            const style = document.createElement('style');
            style.textContent = `
                .pulse-marker {
                    animation: pulse-red 2s infinite;
                }
                @keyframes pulse-red {
                    0% { transform: scale(1); opacity: 1; }
                    50% { transform: scale(1.2); opacity: 0.7; }
                    100% { transform: scale(1); opacity: 1; }
                }
            `;
            document.head.appendChild(style);
            
            // Remove highlight after 10 seconds
            setTimeout(() => {
                map.removeLayer(highlightMarker);
            }, 10000);
            
            // Show area details
            alert(`🎯 FOCUSED ON HIGH RISK AREA\n\n📍 Location: ${area.name}\n⚠️ Risk Level: ${area.description}\n🚨 Severity: ${area.severity}/5\n📊 Coordinates: ${area.lat.toFixed(4)}, ${area.lng.toFixed(4)}\n\n🔍 Map has been focused on this area.\n⏰ Highlight will remain for 10 seconds.\n\n📋 Recommended Actions:\n• Deploy traffic personnel immediately\n• Set up emergency response team\n• Monitor real-time traffic flow\n• Issue public safety advisories`);
        }
        
        function displayGovRiskFactors(data, city) {
            const factorsSection = document.getElementById('riskFactorsSection');
            const factorsGrid = document.getElementById('factorsGrid');
            
            // Calculate government-level risk factors
            const factors = calculateGovRiskFactors(data, city);
            
            // Clear previous factors
            factorsGrid.innerHTML = '';
            
            // Display top 6 most critical factors for government
            factors.slice(0, 6).forEach(factor => {
                const factorElement = createFactorElement(factor);
                factorsGrid.appendChild(factorElement);
            });
            
            // Show the section
            factorsSection.style.display = 'block';
        }
        
        function calculateGovRiskFactors(data, city) {
            const factors = [];
            const currentHour = new Date().getHours();
            const currentDay = new Date().getDay();
            
            // Traffic Density Impact
            const avgSeverity = data.reduce((sum, item) => sum + (item.severity || 2), 0) / data.length;
            let trafficImpact = avgSeverity / 3.0;
            let trafficDesc = '';
            
            if (trafficImpact >= 0.7) {
                trafficDesc = 'Critical traffic congestion detected. Immediate intervention required to prevent accidents.';
            } else if (trafficImpact >= 0.5) {
                trafficDesc = 'High traffic density observed. Enhanced monitoring and traffic management recommended.';
            } else {
                trafficDesc = 'Moderate traffic flow. Standard monitoring protocols sufficient.';
            }
            
            factors.push({
                name: 'Traffic Density',
                impact: trafficImpact,
                value: `${Math.round(trafficImpact * 100)}% Congestion`,
                description: trafficDesc
            });
            
            // Infrastructure Risk
            const highRiskCount = data.filter(item => (item.severity || 2) >= 3).length;
            const infraImpact = Math.min(1.0, highRiskCount / data.length * 2);
            let infraDesc = '';
            
            if (infraImpact >= 0.6) {
                infraDesc = 'Multiple infrastructure bottlenecks identified. Road improvements and traffic signal optimization needed.';
            } else if (infraImpact >= 0.3) {
                infraDesc = 'Some infrastructure concerns detected. Regular maintenance and monitoring recommended.';
            } else {
                infraDesc = 'Infrastructure appears adequate. Continue regular maintenance schedules.';
            }
            
            factors.push({
                name: 'Infrastructure Risk',
                impact: infraImpact,
                value: `${highRiskCount} Critical Points`,
                description: infraDesc
            });
            
            // Time-based Risk Pattern
            let timeImpact = 0;
            let timeDesc = '';
            
            if ((currentHour >= 7 && currentHour <= 10) || (currentHour >= 17 && currentHour <= 20)) {
                timeImpact = 0.8;
                timeDesc = 'Peak traffic hours detected. Deploy additional traffic personnel and activate dynamic signal control.';
            } else if (currentHour >= 22 || currentHour <= 5) {
                timeImpact = 0.6;
                timeDesc = 'Night-time operations. Enhanced patrol units and emergency response readiness required.';
            } else {
                timeImpact = 0.3;
                timeDesc = 'Off-peak hours. Standard traffic management protocols in effect.';
            }
            
            factors.push({
                name: 'Temporal Risk Pattern',
                impact: timeImpact,
                value: `${currentHour.toString().padStart(2, '0')}:00 Analysis`,
                description: timeDesc
            });
            
            // City-specific Risk Profile
            const cityRiskProfiles = {
                'Mumbai': { impact: 0.9, desc: 'Mega-city with complex traffic patterns. Multi-modal transport coordination essential.' },
                'Delhi': { impact: 0.85, desc: 'National capital with high VIP movement. Security and traffic coordination critical.' },
                'Bangalore': { impact: 0.7, desc: 'IT hub with tech-savvy population. Smart traffic solutions and app-based management effective.' },
                'Chennai': { impact: 0.65, desc: 'Industrial center with heavy vehicle traffic. Separate lanes for commercial vehicles recommended.' },
                'Kolkata': { impact: 0.6, desc: 'Cultural capital with narrow roads. Heritage area traffic management requires special attention.' },
                'Hyderabad': { impact: 0.6, desc: 'Growing IT sector. Rapid infrastructure development needed to match population growth.' },
                'Pune': { impact: 0.55, desc: 'Educational hub with young population. Focus on two-wheeler safety and student area management.' },
                'Ahmedabad': { impact: 0.5, desc: 'Commercial center with planned infrastructure. Maintain current traffic management standards.' }
            };
            
            const cityProfile = cityRiskProfiles[city.name] || { impact: 0.4, desc: 'Standard city traffic management protocols applicable.' };
            
            factors.push({
                name: 'City Risk Profile',
                impact: cityProfile.impact,
                value: `${city.name} (${city.population})`,
                description: cityProfile.desc
            });
            
            // Weather Impact (simulated based on season)
            const month = new Date().getMonth() + 1;
            let weatherImpact = 0;
            let weatherDesc = '';
            
            if (month >= 6 && month <= 9) { // Monsoon
                weatherImpact = 0.7;
                weatherDesc = 'Monsoon season active. Waterlogging prevention and emergency drainage systems critical.';
            } else if (month >= 11 || month <= 2) { // Winter
                weatherImpact = 0.4;
                weatherDesc = 'Winter season with potential fog. Enhanced visibility measures and speed control needed.';
            } else { // Summer
                weatherImpact = 0.3;
                weatherDesc = 'Clear weather conditions. Standard traffic management protocols sufficient.';
            }
            
            factors.push({
                name: 'Weather Impact',
                impact: weatherImpact,
                value: getSeasonName(month),
                description: weatherDesc
            });
            
            // Emergency Response Readiness
            const responseImpact = Math.min(1.0, data.length / 10 * 0.5); // Based on data points
            let responseDesc = '';
            
            if (responseImpact >= 0.6) {
                responseDesc = 'High incident probability. Pre-position emergency vehicles and activate rapid response teams.';
            } else if (responseImpact >= 0.3) {
                responseDesc = 'Moderate risk level. Ensure emergency services are on standby with standard response times.';
            } else {
                responseDesc = 'Low risk environment. Maintain regular emergency service schedules.';
            }
            
            factors.push({
                name: 'Emergency Readiness',
                impact: responseImpact,
                value: `${data.length} Monitoring Points`,
                description: responseDesc
            });
            
            // Sort by impact (highest first)
            return factors.sort((a, b) => b.impact - a.impact);
        }
        
        function getSeasonName(month) {
            if (month >= 6 && month <= 9) return 'Monsoon Season';
            if (month >= 11 || month <= 2) return 'Winter Season';
            return 'Summer Season';
        }
        
        function createFactorElement(factor) {
            const div = document.createElement('div');
            div.className = 'factor-item';
            
            const impactLevel = factor.impact >= 0.6 ? 'high' : factor.impact >= 0.3 ? 'medium' : 'low';
            const impactText = factor.impact >= 0.6 ? 'Critical' : factor.impact >= 0.3 ? 'Moderate' : 'Low';
            const impactPercentage = Math.round(factor.impact * 100);
            
            div.innerHTML = `
                <div class="factor-header">
                    <span class="factor-name">${factor.name}</span>
                    <span class="factor-impact impact-${impactLevel}">${impactText}</span>
                </div>
                <div class="factor-bar">
                    <div class="factor-fill" style="width: ${impactPercentage}%; background: ${getImpactColor(impactLevel)}"></div>
                </div>
                <div style="margin: 8px 0; font-weight: 600; color: #374151;">${factor.value}</div>
                <div class="factor-description">${factor.description}</div>
            `;
            
            return div;
        }
        
        function getImpactColor(level) {
            switch(level) {
                case 'high': return '#ef4444';
                case 'medium': return '#f59e0b';
                case 'low': return '#10b981';
                default: return '#6b7280';
            }
        }
        
        function deployEmergencyTeam() {
            const dropdown = document.getElementById('highRiskAreasSelect');
            const selectedIndex = dropdown.value;
            
            if (!selectedIndex || selectedIndex === '') {
                alert('Please select a high risk area first to deploy emergency team.');
                return;
            }
            
            const area = highRiskAreas[selectedIndex];
            const city = cities[currentCity];
            
            alert(`🚨 EMERGENCY TEAM DEPLOYMENT\n\n📍 Target Location: ${area.name}\n🏙️ City: ${city.name}\n⚠️ Risk Level: ${area.description}\n🚨 Severity: ${area.severity}/5\n⏰ Deployment Time: ${new Date().toLocaleString()}\n\n🚑 EMERGENCY RESPONSE ACTIVATED:\n• Traffic Police Unit: Dispatched\n• Ambulance Team: On Standby\n• Fire Safety Unit: Alerted\n• Traffic Control Center: Notified\n\n📞 EMERGENCY CONTACTS:\n• Local Traffic Police: 100\n• Emergency Medical: 108\n• Fire Department: 101\n• Traffic Control Room: 1077\n\n📊 COORDINATES: ${area.lat.toFixed(6)}, ${area.lng.toFixed(6)}\n📋 Reference ID: EMRG-${Date.now()}\n\n✅ All emergency teams have been notified and are responding to the high-risk area.`);
        }
    </script>
</body>
</html>